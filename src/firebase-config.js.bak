import { initializeApp } from "firebase/app";
import {
  initializeFirestore,
  persistentLocalCache,
  persistentSingleTabManager,
  connectFirestoreEmulator,
} from "firebase/firestore";
import {
  getAuth,
  connectAuthEmulator,
  setPersistence,
  browserLocalPersistence,
  inMemoryPersistence,
} from "firebase/auth";
import { getStorage, connectStorageEmulator } from "firebase/storage";

const bool = (v) => ["1","true","yes"].includes(String(v ?? "").toLowerCase());

// ---- Real web config (you said OK to keep in this session) ----
const projectId = import.meta.env.VITE_FIREBASE_PROJECT_ID || "chaotic-neutral-tracker";
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY || "AIzaSyAk1paC3CBjU1RH2cXf_8m6xOnZkH_xYWg",
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN || "chaotic-neutral-tracker.firebaseapp.com",
  projectId,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET || "chaotic-neutral-tracker.firebasestorage.app",
  appId: import.meta.env.VITE_FIREBASE_APP_ID || "1:84127636935:web:fba76e7b8574177e928de2",
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID || "84127636935",
};

const app = initializeApp(firebaseConfig);

// ---- Choose backends (simple & explicit) ----
const useFSemu  = bool(import.meta.env.VITE_USE_FIREBASE_EMULATORS) || bool(import.meta.env.VITE_USE_EMULATORS);
const useSTemu  = useFSemu;
const useAUTHemu = bool(import.meta.env.VITE_USE_AUTH_EMULATOR);  // set 0 or 1 in .env.local

const host = "127.0.0.1";
const fsPort = Number(import.meta.env.VITE_EMULATOR_FIRESTORE_PORT || 8080);
const stPort = Number(import.meta.env.VITE_EMULATOR_STORAGE_PORT || 9199);
const auPort = Number(import.meta.env.VITE_EMULATOR_AUTH_PORT || 9099);

// Firestore (offline cache)
const db = initializeFirestore(app, {
  localCache: persistentLocalCache({ tabManager: persistentSingleTabManager() }),
});

if (useFSemu) connectFirestoreEmulator(db, host, fsPort);

const auth = getAuth(app);
if (useAUTHemu) connectAuthEmulator(auth, `http://${host}:${auPort}`, { disableWarnings: true });
setPersistence(auth, browserLocalPersistence).catch(() => setPersistence(auth, inMemoryPersistence));

const storage = getStorage(app);
if (useSTemu) connectStorageEmulator(storage, host, stPort);

// one-line banner in dev so you can see what youâ€™re using
if (import.meta.env.DEV) {
  console.log(`[firebase] FS=${useFSemu?"emu":"prod"} ST=${useSTemu?"emu":"prod"} AUTH=${useAUTHemu?"emu":"prod"}`);
}

export { app, db, auth, storage };
